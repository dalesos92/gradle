from flask import Flask, request
from flask_restful import Resource, Api, abort, reqparse
import datetime as dt

app = Flask(__name__)
api = Api(app)

# Task 2: Definir la instancia de RequestParser
blogsParser = reqparse.RequestParser()
# Agregar los argumentos requeridos con sus validaciones
blogsParser.add_argument('title', type=str, required=True, help="Title is a mandatory argument")
blogsParser.add_argument('article_text', type=str, required=True, help="Article text is a mandatory argument")

blogs = {}

class BlogsAPI(Resource):
    def get(self, blog_id=None):
        '''Return 'blogs' dictionary if 'blog_id' is None.'''
        if blog_id is None:
            return blogs
        
        '''Abort the request if 'blog_id' not in keys of 'blogs' dictionary'''
        if blog_id not in blogs:
            abort(404, message="Blog_Id {} doesn't exist".format(blog_id))
            
        return blogs[blog_id]

    def post(self, blog_id):
        '''If 'blog_id' is in keys of 'blogs' dictionary, abort the request.'''
        if blog_id in blogs:
            abort(400, message="Blog_Id {} already exists".format(blog_id))
            
        # Task 3: Usar 'blogsParser' para parsear los argumentos
        args = blogsParser.parse_args()
        
        # Crear fecha actual usando el alias 'dt' que viene en el import del template
        created_at = dt.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        blog = {
            'title': args['title'],
            'article_text': args['article_text'],
            'created_at': created_at
        }
        
        blogs[blog_id] = blog
        return blog

    def put(self, blog_id):
        '''If given 'blog_id' not in 'blogs' dictionary abort the request'''
        if blog_id not in blogs:
            abort(404, message="Blog_Id {} doesn't exist".format(blog_id))
            
        # Usar 'blogsParser' para validar y obtener los nuevos argumentos
        args = blogsParser.parse_args()
        
        # Actualizar los detalles
        blogs[blog_id]['title'] = args['title']
        blogs[blog_id]['article_text'] = args['article_text']
            
        return blogs[blog_id]

    def delete(self, blog_id):
        '''If 'blog_id' not in keys of 'blogs' dictionary, abort the request'''
        if blog_id not in blogs:
            abort(404, message="Blog_Id {} doesn't exist".format(blog_id))
            
        del blogs[blog_id]
        return "Blog with Id {} is deleted".format(blog_id)

# Mapear el recurso a las URLs solicitadas
api.add_resource(BlogsAPI, '/blogs/',
                           '/blogs/<int:blog_id>/')

if __name__ == '__main__':
    app.run(debug=True)
